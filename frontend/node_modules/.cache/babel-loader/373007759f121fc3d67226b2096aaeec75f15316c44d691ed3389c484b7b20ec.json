{"ast":null,"code":"var _jsxFileName = \"C:\\\\Users\\\\duyan\\\\trangsucvn\\\\frontend\\\\src\\\\context\\\\CartContext.js\",\n  _s = $RefreshSig$();\nimport React, { createContext, useState, useEffect, useContext } from \"react\";\nimport { AuthContext } from \"./AuthContext\"; // Import để lấy user/token\nimport axios from \"axios\";\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nexport const CartContext = /*#__PURE__*/createContext();\nexport const CartProvider = ({\n  children\n}) => {\n  _s();\n  const [cart, setCart] = useState([]);\n  const {\n    user,\n    token\n  } = useContext(AuthContext); // Lấy user/token từ Auth (nếu có)\n\n  // Load local cart khi init\n  useEffect(() => {\n    const savedCart = localStorage.getItem(\"cart\");\n    if (savedCart) {\n      setCart(JSON.parse(savedCart));\n    }\n  }, []);\n\n  // Sync localStorage khi cart thay đổi\n  useEffect(() => {\n    localStorage.setItem(\"cart\", JSON.stringify(cart));\n  }, [cart]);\n\n  // Fetch cart từ server khi user login (hoặc user thay đổi)\n  useEffect(() => {\n    if (user && token) {\n      fetchCartFromServer();\n    }\n  }, [user, token]); // Chạy khi login/logout\n\n  const fetchCartFromServer = async () => {\n    try {\n      const res = await axios.get(\"http://localhost:5000/api/cart\");\n      if (res.data && res.data.items && res.data.items.length > 0) {\n        // Merge server cart với local: Ưu tiên server quantity, thêm item mới nếu local có\n        const serverItemsMap = new Map(res.data.items.map(item => [item.product_id.toString(), item]));\n        const mergedCart = cart.map(localItem => {\n          const serverItem = serverItemsMap.get(localItem._id);\n          if (serverItem) {\n            // Sync quantity từ server, giữ local info (name, imageUrl...)\n            return {\n              ...localItem,\n              quantity: serverItem.quantity\n            };\n          }\n          return localItem; // Giữ local nếu server chưa có\n        }).concat(\n        // Thêm item từ server không có trong local\n        res.data.items.filter(serverItem => !cart.some(localItem => localItem._id === serverItem.product_id.toString())).map(serverItem => ({\n          _id: serverItem.product_id.toString(),\n          name: serverItem.name,\n          price: serverItem.price,\n          imageUrl: serverItem.imageUrl || \"\",\n          // Nếu server lưu imageUrl, thêm vào model\n          quantity: serverItem.quantity\n        })));\n        setCart(mergedCart);\n      }\n    } catch (error) {\n      console.error(\"Lỗi fetch cart từ server:\", error);\n      // Không rollback, giữ local nếu server lỗi\n    }\n  };\n\n  // Helper: Sync action lên server nếu logged in\n  const syncToServer = async (action, productId = null, quantity = null) => {\n    if (!user || !token) return; // Guest: Chỉ local\n\n    try {\n      switch (action) {\n        case \"add\":\n        case \"update\":\n          await axios.post(\"http://localhost:5000/api/cart/add\", {\n            productId,\n            quantity\n          });\n          break;\n        case \"remove\":\n          await axios.delete(`http://localhost:5000/api/cart/remove/${productId}`);\n          break;\n        case \"clear\":\n          await axios.put(\"http://localhost:5000/api/cart/clear\");\n          break;\n        default:\n          break;\n      }\n    } catch (error) {\n      console.error(`Lỗi sync ${action} cart:`, error);\n      // Optional: Rollback local nếu cần, nhưng để UI mượt thì không\n    }\n  };\n  const addToCart = product => {\n    const existing = cart.find(item => item._id === product._id);\n    let newCart;\n    if (existing) {\n      newCart = cart.map(item => item._id === product._id ? {\n        ...item,\n        quantity: item.quantity + 1\n      } : item);\n    } else {\n      newCart = [...cart, {\n        ...product,\n        quantity: 1\n      }];\n    }\n    setCart(newCart);\n    // Sync nếu logged in\n    syncToServer(\"update\", product._id, existing ? existing.quantity + 1 : 1);\n  };\n  const removeFromCart = productId => {\n    const newCart = cart.filter(item => item._id !== productId);\n    setCart(newCart);\n    // Sync nếu logged in\n    syncToServer(\"remove\", productId);\n  };\n  const updateQuantity = (productId, quantity) => {\n    if (quantity <= 0) {\n      removeFromCart(productId);\n      return;\n    }\n    const newCart = cart.map(item => item._id === productId ? {\n      ...item,\n      quantity\n    } : item);\n    setCart(newCart);\n    // Sync nếu logged in\n    syncToServer(\"update\", productId, quantity);\n  };\n  const clearCart = () => {\n    setCart([]);\n    // Sync nếu logged in\n    syncToServer(\"clear\");\n  };\n  const getTotal = () => {\n    return cart.reduce((total, item) => total + item.price * item.quantity, 0);\n  };\n  return /*#__PURE__*/_jsxDEV(CartContext.Provider, {\n    value: {\n      cart,\n      addToCart,\n      removeFromCart,\n      updateQuantity,\n      clearCart,\n      getTotal\n    },\n    children: children\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 157,\n    columnNumber: 5\n  }, this);\n};\n_s(CartProvider, \"dTuhME0ow02TeVWPteat7m9vE7I=\");\n_c = CartProvider;\nvar _c;\n$RefreshReg$(_c, \"CartProvider\");","map":{"version":3,"names":["React","createContext","useState","useEffect","useContext","AuthContext","axios","jsxDEV","_jsxDEV","CartContext","CartProvider","children","_s","cart","setCart","user","token","savedCart","localStorage","getItem","JSON","parse","setItem","stringify","fetchCartFromServer","res","get","data","items","length","serverItemsMap","Map","map","item","product_id","toString","mergedCart","localItem","serverItem","_id","quantity","concat","filter","some","name","price","imageUrl","error","console","syncToServer","action","productId","post","delete","put","addToCart","product","existing","find","newCart","removeFromCart","updateQuantity","clearCart","getTotal","reduce","total","Provider","value","fileName","_jsxFileName","lineNumber","columnNumber","_c","$RefreshReg$"],"sources":["C:/Users/duyan/trangsucvn/frontend/src/context/CartContext.js"],"sourcesContent":["import React, { createContext, useState, useEffect, useContext } from \"react\";\r\nimport { AuthContext } from \"./AuthContext\"; // Import để lấy user/token\r\nimport axios from \"axios\";\r\n\r\nexport const CartContext = createContext();\r\n\r\nexport const CartProvider = ({ children }) => {\r\n  const [cart, setCart] = useState([]);\r\n  const { user, token } = useContext(AuthContext); // Lấy user/token từ Auth (nếu có)\r\n\r\n  // Load local cart khi init\r\n  useEffect(() => {\r\n    const savedCart = localStorage.getItem(\"cart\");\r\n    if (savedCart) {\r\n      setCart(JSON.parse(savedCart));\r\n    }\r\n  }, []);\r\n\r\n  // Sync localStorage khi cart thay đổi\r\n  useEffect(() => {\r\n    localStorage.setItem(\"cart\", JSON.stringify(cart));\r\n  }, [cart]);\r\n\r\n  // Fetch cart từ server khi user login (hoặc user thay đổi)\r\n  useEffect(() => {\r\n    if (user && token) {\r\n      fetchCartFromServer();\r\n    }\r\n  }, [user, token]); // Chạy khi login/logout\r\n\r\n  const fetchCartFromServer = async () => {\r\n    try {\r\n      const res = await axios.get(\"http://localhost:5000/api/cart\");\r\n      if (res.data && res.data.items && res.data.items.length > 0) {\r\n        // Merge server cart với local: Ưu tiên server quantity, thêm item mới nếu local có\r\n        const serverItemsMap = new Map(\r\n          res.data.items.map((item) => [item.product_id.toString(), item])\r\n        );\r\n\r\n        const mergedCart = cart\r\n          .map((localItem) => {\r\n            const serverItem = serverItemsMap.get(localItem._id);\r\n            if (serverItem) {\r\n              // Sync quantity từ server, giữ local info (name, imageUrl...)\r\n              return { ...localItem, quantity: serverItem.quantity };\r\n            }\r\n            return localItem; // Giữ local nếu server chưa có\r\n          })\r\n          .concat(\r\n            // Thêm item từ server không có trong local\r\n            res.data.items\r\n              .filter(\r\n                (serverItem) =>\r\n                  !cart.some(\r\n                    (localItem) =>\r\n                      localItem._id === serverItem.product_id.toString()\r\n                  )\r\n              )\r\n              .map((serverItem) => ({\r\n                _id: serverItem.product_id.toString(),\r\n                name: serverItem.name,\r\n                price: serverItem.price,\r\n                imageUrl: serverItem.imageUrl || \"\", // Nếu server lưu imageUrl, thêm vào model\r\n                quantity: serverItem.quantity,\r\n              }))\r\n          );\r\n\r\n        setCart(mergedCart);\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Lỗi fetch cart từ server:\", error);\r\n      // Không rollback, giữ local nếu server lỗi\r\n    }\r\n  };\r\n\r\n  // Helper: Sync action lên server nếu logged in\r\n  const syncToServer = async (action, productId = null, quantity = null) => {\r\n    if (!user || !token) return; // Guest: Chỉ local\r\n\r\n    try {\r\n      switch (action) {\r\n        case \"add\":\r\n        case \"update\":\r\n          await axios.post(\"http://localhost:5000/api/cart/add\", {\r\n            productId,\r\n            quantity,\r\n          });\r\n          break;\r\n        case \"remove\":\r\n          await axios.delete(\r\n            `http://localhost:5000/api/cart/remove/${productId}`\r\n          );\r\n          break;\r\n        case \"clear\":\r\n          await axios.put(\"http://localhost:5000/api/cart/clear\");\r\n          break;\r\n        default:\r\n          break;\r\n      }\r\n    } catch (error) {\r\n      console.error(`Lỗi sync ${action} cart:`, error);\r\n      // Optional: Rollback local nếu cần, nhưng để UI mượt thì không\r\n    }\r\n  };\r\n\r\n  const addToCart = (product) => {\r\n    const existing = cart.find((item) => item._id === product._id);\r\n\r\n    let newCart;\r\n    if (existing) {\r\n      newCart = cart.map((item) =>\r\n        item._id === product._id\r\n          ? { ...item, quantity: item.quantity + 1 }\r\n          : item\r\n      );\r\n    } else {\r\n      newCart = [...cart, { ...product, quantity: 1 }];\r\n    }\r\n\r\n    setCart(newCart);\r\n    // Sync nếu logged in\r\n    syncToServer(\"update\", product._id, existing ? existing.quantity + 1 : 1);\r\n  };\r\n\r\n  const removeFromCart = (productId) => {\r\n    const newCart = cart.filter((item) => item._id !== productId);\r\n    setCart(newCart);\r\n    // Sync nếu logged in\r\n    syncToServer(\"remove\", productId);\r\n  };\r\n\r\n  const updateQuantity = (productId, quantity) => {\r\n    if (quantity <= 0) {\r\n      removeFromCart(productId);\r\n      return;\r\n    }\r\n\r\n    const newCart = cart.map((item) =>\r\n      item._id === productId ? { ...item, quantity } : item\r\n    );\r\n    setCart(newCart);\r\n    // Sync nếu logged in\r\n    syncToServer(\"update\", productId, quantity);\r\n  };\r\n\r\n  const clearCart = () => {\r\n    setCart([]);\r\n    // Sync nếu logged in\r\n    syncToServer(\"clear\");\r\n  };\r\n\r\n  const getTotal = () => {\r\n    return cart.reduce((total, item) => total + item.price * item.quantity, 0);\r\n  };\r\n\r\n  return (\r\n    <CartContext.Provider\r\n      value={{\r\n        cart,\r\n        addToCart,\r\n        removeFromCart,\r\n        updateQuantity,\r\n        clearCart,\r\n        getTotal,\r\n      }}\r\n    >\r\n      {children}\r\n    </CartContext.Provider>\r\n  );\r\n};\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}